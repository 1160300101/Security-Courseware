# 比特币与区块链

### 哈尔滨工业大学 网络与信息安全 张宇 2018

---

## 1. 比特币(Bitcoin)与区块链(Blockchain)简介

### 1.1. 介绍

- [Bitcoin(比特币)](https://en.wikipedia.org/wiki/Bitcoin)是一种加密货币(cryptocurrency)，于2008年在密码朋克(Cypherpunks)邮件列表中的一份[以中本聪为笔名的白皮书](https://bitcoin.org/bitcoin.pdf)中被提出，紧接着原始参考客户端的源代码([Bitcoin Core](https://bitcoincore.org))被发布。比特币是第一个实践上解决了双重支付(double-spending)问题的数字货币，而不需要依赖于可信的第三方或中央服务器。比特币的创世块在2009年1月3日被挖出。比特币首次作为现金被使用是通过2010年5月的一笔交易，一名用户以1万比特币作为交换，为另一个人订了一份比萨饼外卖。[2018年1月，比特币市值已经达到2千5百亿美元](https://coinmarketcap.com/currencies/bitcoin/)。

- [区块链(Blockchain)](https://en.wikipedia.org/wiki/Blockchain)，作为比特币核心技术组件之一，现在已经泛指整个比特币所采用技术的集合。狭义上，区块链是一种分布式数据结构，指一个不断增长、顺序相连的记录列表，每个记录被称为“区块”，块内包含若干交易(transaction)。区块链的主要功能之一是作为一个分布式的“公开记账簿”(public ledger)来记录各方之间的交易，具有可验证、只追加、防篡改等性质。

比特币的其他核心技术组件还包括交易与脚本、基于[工作量证明(PoW)](https://en.wikipedia.org/wiki/Proof-of-work_system#Bitcoin-type_proof-of-work)的共识(consensus)机制、P2P网络等。

### 1.2. 理解比特币

- 普林斯顿大学课程[《Bitcoin and Cryptocurrency Technologies》](http://bitcoinbook.cs.princeton.edu)

下面给出一个对比特币/区块链技术的理解。

#### 1.2.0 货币与数字货币

- 百度百科：货币本质上是一种所有者与市场关于交换权的契约，根本上是所有者相互之间的约定。吾以吾之所有予市场，换吾之所需，货币就是这一过程的约定，它反映的是个体与社会的经济协作关系。
- 数字货币与纸币一样，本质上都属于纯信用货币。数字货币的具体形态可以是以一个来源于实体账户的数字，也可以是记于名下的一串由特定密码学与共识算法验证的数字。

比特币可以看作是一种“记账货币”（money of accounts）：在一个账户上的一个数字（余额），包含信用账目及其清算所构成的体系。与通常的纸币类似，具有以下性质。

- 不可窃取货币：余额不能凭空减少。
- 不可伪造货币：余额不能凭空增加。

与一般安全问题相似，数字货币满足安全需求依赖于两点：信任假设与安全机制

#### 1.2.1 交易、账簿、公钥与数字签名

假设在一次Alice与Bob的交易中，Alice向Bob转帐10元钱，用于购买Bob做的一张披萨饼（或其他任何商品，甚至什么也不买）。在数字世界中，并没有实物的钞票或硬币，这次交易只是一个信息，称做一条交易记录：

```
From: Alice  To: Bob  Amount: 10 
```

这里我们并不关心披萨饼。从信息安全角度，该交易以及账簿需要满足以下安全属性：

- 真实性：不能伪装成其他人，否则会被发现。
- 完整性：交易发生后，不能更改交易内容，否则会被发现。
- 不可否认性：交易发生后，双方不能否认该交易。

如果Alice或Bob只有一个人做记录，则这个做记录的人可以随意打破上述安全属性。所以，两个人应该分别在各自的账簿中做记录。假想这样一种情况，全世界只有Alice和Bob两个人，那么以上安全属性是否天然地满足了，或者这些安全属性已经毫无意义？

- 真实性：若Bob伪装成Alice伪造上述交易，则Alice通过查看自己的账簿可以发现。满足！
- 完整性：某一个人篡改账簿，则另一个人会发现。满足！
- 不可否认性：若Alice否认交易，则Bob也无计可施。反之一样。或者说此时，二者之间的不可否认性没有意义！

为了满足不可否认性，Alice和Bob一致同意引入一个双方都信任的公证人Charlie。Charlie做公正的方法是对每笔交易做记录，当Alice和Bob发生争议时，以Charlie自己的账簿为准。不可否认性也得到了满足！同时，Charlie也可以检查真实性与完整性。这种三个人的记账方法被称为“三式记账法”(triple-entry bookkeeping)。

Alice真的有10元钱吗？把这个问题先放一边，考虑这次交易如果成功，则Bob的账户多了10元钱，此后Bob可支出10元钱。如果能证明Alice在之前的交易中获得了超过10元钱，并且到此次交易之前账户余额仍超过10元钱，则意味着Alice也能够支付10元钱。Bob在交易前可以向Charlie询问关于Alice的账户是否多余10元钱。

与参与交易的当事人不同，Charlie并不是直接地获得原始交易记录，而是间接地通过交易双方获得。因此，在Charlie获得交易记录也需要满足上述安全属性。

此时，公钥密码学中的数字签名有了用武之地。Alice公布其公钥，并用对应私钥对交易记录签名。Charlie在内的所有人可以用Alice的公钥验证记录。如何安全地获得Alice的公钥，此处不做讨论。考虑到Bob是获利方，并简化问题，不需要Bob的数字签名。那么，交易记录内容如下：

```
From: Alice  To: Bob  Amount: 10 
Sig: a signature siged by Alice
```

付款方的数字签名提供了 真实性+完整性+不可否认性：只有Alice才能产生有效签名。
只要有Alice的公钥，上述安全属性可以公开验证。

为此，Charlie需要维护一个`From`字段中账号ID与用来验证`Sig`字段的公钥的映射表。其实，Charlie关心的并不是一个账号的ID，而是ID与公钥的映射关系，那么就可以把公钥（或其密码学哈希值，称为比特币地址）直接作为账号。这样，`From`字段就可以填上Alice（具体叫什么名字已经没有实际意义）的公钥。

紧接着此次交易之后，Bob打算向其他人转账5元钱，并提交一个新交易记录给Charlie。此时，Charlie需要确认上次交易里收款方`To`字段里的Bob和此次交易`From`里付款方公钥的映射关系。显然，这个映射也可以通过将`To`字段填充上收款方的公钥来省略。以公钥为账户就避免了这种额外的映射。这样之前交易记录的内容如下：

```
From: Alice's pub key  To: Bob's pub key   Amount: 10
Sig: a signature siged by Alice
```

至此我们设计了一种记账货币：

- 信任假设：负责记账的Charlie是可信的。
- 安全机制：带有数字签名的交易记录在账簿上。

该货币满足基本需求：

- 不可窃取货币：余额不能凭空减少。
- 不可伪造货币：余额不能凭空增加。

#### 1.2.2 比特币交易与区块链

Charlie记账时需要对交易排序，比特币采用一种逻辑时间戳方式的纪录方式：

- 每个交易包含一个排序：输入队列和输出队列；转账记录被包含在交易输出中。
- 交易输入包含指向之前交易输出的索引，其中本次交易输出的付款人是之前交易输出收款人。
- 每个交易中输入之和大于输出之和。尚未支出的输出，称为UTXO(Unspent Transaction Output)。
- 近似固定时间间隔内的所有交易打包记录，称为“区块”(Block)。
- 每一区块中包含前一区块内容的哈希值，以此区块顺序相连构成账簿，称为“区块链”。

区块链记录了每一笔交易，由此可以计算出账户的UTXO。

```
Transaction 1:
Inputs:
From: Alice's pub key  To: Bob's pub key   Amount: 10
Sig: a signature siged by Alice

Outputs:
From: Bob's pub key  To: Dave's pub key   Amount: 10
Sig: a signature siged by Bob
```

#### 1.2.3 双重支付与分布式一致性

- 双重支付：假设Alice从一笔交易A中收入10元，在一笔新交易B中以该交易A向Bob支付10元钱的同时，在另一笔交易D中也以交易A向Dave支付10元钱。
- 为防范“双重支付”，采用“先记账，后交易”的方法：
	- Charlie保证此前交易T收入尚未被支付，将交易B或D中的一个写入账簿中，T被支付。
	- Bob或Dave查看Charlie的账簿，若该交易B／D被记录，则执行该交易。
	- Alice若实施双重支付，则要在账簿中写入两笔交易，而其中较晚的交易由于T已经被支付而无效。

只要Charlie是可信的，则“双重支付”问题可以避免。

打破假设：Charlie作恶，例如故意不记录某些交易，或维护多个不同的账簿，或者账簿被烧毁了，则之前的安全属性无法满足。那么我们应该相信谁，或者说谁来记录并维护这个账簿，谁有记账权？

比特币的思想是不相信某个特定的人，而是相信“大多数人是好的”，信任多数人的意见。Bob调整了确认Alice支付交易已经被记入账簿的条件，询问足够多的人（例如超过全体记账人的一半），如果这些人都确认记录了该笔交易，则Bob才认为交易有效。只要大多数人如实地记账，Alice若双重支付，则会被大多数人记录并发现。

比特币系统中有多人负责记账，称为“分布式账簿”。进一步的，系统是开放的，记账人并没有事先约定，可以随时加入和退出。这种复杂性带来了两方面安全问题：

- 一致性问题：无法获知系统全局状态，例如有多少记账人。一个交易记录在发送个记账人的过程中可能被阻断、丢失或者延迟，或者攻击者对不同的记账人发送不同的交易记录，导致不同的账簿不一致。

分布式账簿不一致，称为区块链“分叉”，存在“双重支付”风险：分叉之前Alice有一笔10元收入交易，此后在一个Bob所查看的账簿上记录付给Bob，在另一个Dave所查看账簿上记录付给Dave；Bob和Dave单独看各自账都会承认交易有效。

不幸的是，当前理论研究已经证明实现上述问题是无法解决的。

- CAP定理指出，一致性(C，所有复本都一样)、可用性(A，对状态查询做出应答)和分割容忍(P，网络被分割成多个互不连通的部分)三者只能同时满足两点，即当网络分割不可避免时，一致性和可用性不能同时满足。
- FLP不可能性指出，安全性(safety，所有节点输出相同的值)、活性(liveness，非故障节点最终会输出一个值)和容错（fault tolerance，在停机故障或拜占庭故障条件下仍达成前两个目标）不可能在异步(asychronous，消息传递时延无上界)系统中同时满足。

另一个问题是女巫(Sybil)攻击：一个攻击者伪装成多个记账人，我们看到的“大多数人”实际上可能只是少数攻击者伪装的。

因此，比特币放松了对分布式一致性的要求，而追求一下目标：

- 不一致的冲突会以可预测的方式化解。
- 账簿会暂时不一致，但在概率上最终会收敛，即达成一致。
- 可抵御女巫攻击。

注意，此时的好节点不单单是如实记账，还意味着遵守协议并正常运行。

#### 1.2.4 工作量证明(PoW)

先来解决女巫攻击。当根据大多数人的意见来确认一笔交易时，类似于针对该交易的一次全体投票。女巫攻击就是伪造多个身份，从而投出多张选票。防范女巫攻击，需要提高投票成本，但不提高验票的代价。注意，防范女巫攻击不是识别或禁止“坏人的票”，而是防止一人多投。

- 对策是工作量证明(PoW)，或者说是“一CPU一票”。记账需要解决一个计算难题，难题被解决意味着付出了（概率上的）足够的工作量，才能添加区块。
	- 寻找（猜测）一个数值Nonce（只出现一次的随机数），使得一个新区块的哈希值小于一个预先指定的数值（哈希值满足开头连续若干位为0）。

```
Nonce: to be determined by guess
Previous block hash
Transacations
```

- 一个节点选择一个新区块的过程：
	- 第一个包含了一个计算难题的解的有效区块被认为是正确的。一旦收到它，其它参与者将开始寻找下一区块。
	- 如果一个声明的区块包含了无效交易，或者格式错误，那么所有其它参与者将拒绝它，并继续工作直到它们发现一个有效区块的解。

- 难题具有随机性：用非随机的难题（真正的工作量证明），最强大的记账人可能会首先找到每一个区块。通过随机难题，每个记账人找到下一个区块的概率与其竞争算力所占份额成比例。

#### 1.2.5 交易费用、采矿、记账与激励

货币是如何产生的？答案就是比特币是系统“原生的”，通过采矿（凭算力）获得。

基于工作量证明的记账需要代价(设备投资、电力和时间)，由此引发两个问题：

- 记账人为什么愿意付出算力？
	- 解决方案是记账人在成功解决难题并记账后会获得一定比特币奖励。最初，每个区块创建50比特币。目前已经减半到25比特币，并且计划约每四年减半，直到约2140年，那时不再创造新比特币。因此，记账活动也称为采矿，记账人也称为矿工。
	- 	为了让货币创造能够逐渐关闭，矿工不仅从区块奖励中获利，它们也可以获得区块中包含的交易获得交易费。每笔交易中包含一部分未指定收款方的费用（具体地，交易中还需指定之前交易作为输入，当前交易作为输出，两者之间净值差异为交易费）。
- 攻击者产生过多小型交易（称为一分钱泛滥）来过度使用记账服务，从而浪费算力。
	- 矿工会设置一个最小交易费，低于该费用的交易不会被加入到区块中。


#### 1.2.6 P2P网络

记账安全依赖于信息公开！

- 交易双方希望交易信息被所有矿工接收并尽快记账。
- 矿工希望尽快收到所有交易，采矿后尽快将区块发送给其他矿工。

这需要节点之间有效的发现彼此并通信。

- 任何节点都可以通过连接到一些随机的其他节点来加入网络。 默认情况下，每个节点尝试建立8个外出连接，并准备接收最多125个进入连接。
- 加入网络的节点最初需要一个找到其它节点的方法。像许多其它P2P网络一样，比特币通过使用专用目录服务器或“种子节点”来实现这一目标，其身份被硬编码到参考客户端中; 此后，每个节点维护它所知道的对等地址列表。

节点间还通过其它两种机制传播彼此信息：

- 首先，当一个节点建立一个新的外出连接时，它会触发一系列包含其连接信息的中继消息；
- 其次，在收到进入连接时，节点向其对等方询问一部分已知地址列表。

这种机制构建了一个连接良好的随机网络，具有低节点度和低直径，适合通过扩散快速广播信息。

新区块和待处理交易通过洪泛广播到整个网络。

- 无论何时第一次听到它们，节点都会将包含新区块或待处理交易的哈希值的INV消息发送给所有节点。
- 如果对等体尚未见过它们，则可以通过请求这些块或交易的全部内容来做出响应（通过GETDATA消息）。
- 默认情况下，节点只会转发一次新数据，以防止无限传播；
- 只传递交易和有效区块；
- 在临时分叉中发现两个区块时只传递第一个听到的区块；
- 不会广播与已发送的待处理交易相冲突（双重支付）的待处理交易。

#### 1.2.7 回到一致性：分布式共识

PoW、激励和P2P网络还不能解决一致性问题，因为还是无法得知参与者的总数和他们的身份：不知道要联系多少人来获得足够多的同意；不知道要联系谁来获得他们的同意，甚至不知道在与谁通话。

一个基本认识是询问的人越多，则获得真实信息的可能性也越大；而人头数体现为工作量，所以工作量越大的信息越可信；工作量又体现为账簿上区块的数量，即区块链长度。比特币采用以下共识方案：

- 每个节点以其所知的最早的、最长的那一条区块链作为账簿。

这一方案将“多数人共识”实现为“最长链”。

然而，如果只以“现在的”最长链为“最长链”，双重支付风险仍存在，原因有两点：

- 同一时刻：无法保证所有节点获知该链，而且可能有多个长度相同链。
- 不同时刻：现在最长的不一定以后也是最长的。

为此，希望获得足够的信心来确认交易被永久记录，确认交易所在区块会永久地在最长链上的方法是：

- 交易记录被加入到最长链，随后一共加入了N个区块仍然是最长链。

比特币中区块每10分钟产生一个，N=6，这样在一个交易产生后约60分钟后被确认记录。

在P2P网络运转良好条件下，经过足够长的时间，可以相信所有节点都获知了之前的交易。上述的“同一时刻”不同最长链的情况可以排除。

攻击者利用“不同时刻”最长链实施攻击。

1. 攻击者付款给Bob，并且该交易T被记录在最长“诚实链”中。同时，攻击者也默默地计算不含交易T的“攻击链”。
2. 当Bob等待在“诚实链”上N个新区块确认交易后，攻击者将“攻击链”公开发布。
3. 若“攻击链”比“诚实链”长，则交易T被撤销，攻击者可实现双重支付。

在比特币白皮书中，分析了攻击者成功的概率P：

- 攻击者算力占比q>0.5，则P为100%，也被称为“51%攻击”
- 攻击者算力占比q<0.5，“攻击链”在落后N块之后，能够追赶上“诚实链”的概率P随着N指数衰退。
例如，当q=0.1, N=5时，P=0.0009137；N=10时，P=0.0000012。

#### 1.2.8 小结

- 记账货币：账簿上记录每一笔转账交易。
- 账户/签名：账户用公钥标识，每笔交易由付款方用私钥签名。
- 区块链：交易包含输入和输出，交易打包成区块，区块顺序相连。
- 分布式账簿：多节点维护账簿，存在一致性问题与女巫攻击。
- 工作量证明：先解决计算难题的节点获得“记账权”，与算力成比例。
- 采矿激励：记账的同时获得奖励。
- P2P网络：将交易和区块传播到所有节点。
- 共识机制：最长的一条区块链作为账簿，交易需N个区块确认。

---
