# 比特币与区块链

### 哈尔滨工业大学 网络与信息安全 张宇 2018

---

## 1. 比特币(Bitcoin)与区块链(Blockchain)简介

### 1.1. 介绍

- [Bitcoin(比特币)](https://en.wikipedia.org/wiki/Bitcoin)是一种加密货币(cryptocurrency)，于2008年在密码朋克(Cypherpunks)邮件列表中的一份[以中本聪为笔名的白皮书](https://bitcoin.org/bitcoin.pdf)中被提出，紧接着原始参考客户端的源代码([Bitcoin Core](https://bitcoincore.org))被发布。比特币是第一个实践上解决了双重支付(double-spending)问题的数字货币，而不需要依赖于可信的第三方或中央服务器。比特币的创世块在2009年1月3日被挖出。比特币首次作为现金被使用是通过2010年5月的一笔交易，一名用户以1万比特币作为交换，为另一个人订了一份比萨饼外卖。[2018年1月，比特币市值已经达到2千5百亿美元](https://coinmarketcap.com/currencies/bitcoin/)。

- [区块链(Blockchain)](https://en.wikipedia.org/wiki/Blockchain)，作为比特币核心技术组件之一，现在已经泛指整个比特币所采用技术的集合。狭义上，区块链是一种分布式数据结构，指一个不断增长、顺序相连的记录列表，每个记录被称为“区块”，块内包含若干交易(transaction)。区块链的主要功能之一是作为一个分布式的“公开记账簿”(public ledger)来记录各方之间的交易，具有可验证、只追加、防篡改等性质。

比特币的其他核心技术组件还包括交易与脚本、基于[工作量证明(PoW)](https://en.wikipedia.org/wiki/Proof-of-work_system#Bitcoin-type_proof-of-work)的共识(consensus)机制、P2P网络等。

### 1.2. 理解比特币

- 普林斯顿大学课程[《Bitcoin and Cryptocurrency Technologies》](http://bitcoinbook.cs.princeton.edu)
- 最小可行区块链（[Minimum Viable Block Chain](https://www.igvita.com/2014/05/05/minimum-viable-block-chain/))([中译文](http://geek.csdn.net/news/detail/135684))

下面给出一个我对的比特币/区块链技术的极简理解。

#### 1.2.1 交易、区块、账簿、公钥与数字签名

假设在一次Alice与Bob的交易中，Alice向Bob转帐10元钱，用于购买Bob做的一张披萨饼（或其他任何商品，甚至什么也不买）。在数字世界中，并没有实物的钞票或硬币，这次交易只是一个信息，称做一条记录：

```
From: Alice  
To: Bob 
Qty: 10 
Time: 2018-04-23-17:08
```

这里我们并不关心披萨饼。
从信息安全角度，该交易以及账簿需要满足以下安全属性：

- 真实性：不能伪装成其他人，否则会被发现。
- 不可否认性：交易发生后，双方不能否认该交易。
- 完整性：交易发生后，不能更改交易内容，否则会被发现。

如果Alice或Bob只有一个人做记录，则这个做记录的人可以随意打破上述安全属性。所以，两个人应该分别在各自的账簿中做记录。假设一本账簿包含许多页，每一页记录了一个固定时间间隔内的所有交易，称为“区块”(Block)。每一页（区块）中包含前一页的标识（前一区块内容的哈希值），以此这些页之间顺序相连构成账簿，称为“区块链”。

假想这样一种情况，全世界只有Alice和Bob两个人，那么以上安全属性是否天然地满足了，或者这些安全属性已经毫无意义？

- 真实性：若Bob伪装成Alice伪造上述交易，则Alice通过查看自己的账簿可以发现。满足！
- 不可否认性：若Alice否认交易，则Bob也无计可施。不满足！或者说此时，不可否认性已经没有意义！
- 完整性：某一个人篡改账簿，则另一个人会发现。满足！

当然，数字货币用户要多余两个人。为了满足不可否认性，Alice和Bob一致同意引入一个双方都信任的公证人Charlie。Charlie做公正的方法是对每笔交易做记录，当Alice和Bob发生争议时，以Charlie自己的账簿为准。不可否认性也得到了满足！同时，Charlie也可以检查真实性与完整性。这种三个人的记账方法被称为“三式记账法”(triple-entry bookkeeping)。

此时，有一个被忽略了的问题：Alice真的有10元钱吗？把这个问题先放一边，考虑这次交易如果成功，则Bob的账户多了10元钱，此后Bob可支出10元钱。如果能证明Alice在之前的交易中获得了超过10元钱，并且到此次交易之前账户余额仍超过10元钱，则意味着Alice也能够支付10元钱。Bob在交易前可以向Charlie询问关于Alice的账户是否多余10元钱。

因此，Charlie的账簿需要记录建立账簿时每个参与者账户余额（称为“创世块”），并‘依次’记录之后每一笔交易（对账簿的操作），由此可以计算出账户余额（称为“当前状态”）。

然而，这其中还有问题：与参与交易的当事人不同，Charlie并不是直接地获得原始交易记录，而是间接地通过交易双方获得。因此，在Charlie获得交易记录过程中，也需要满足上述安全属性。此时，公钥密码学中的数字签名有了用武之地。Alice公布其公钥，并用对应私钥对交易记录签名。Charlie在内的所有人可以用Alice的公钥验证记录。如何安全地获得Alice的公钥，此处不做讨论。考虑到Bob是获利方，并简化问题，不需要Bob的数字签名。那么，交易记录内容如下：

```
From: Alice  
To: Bob 
Qty: 10 
Time: 2018-04-23-17:08
Sig: a signature siged by Alice
```

为了验证这个交易与签名，Charlie需要维护一个`From`字段中账号ID与用来验证`Sig`字段的公钥的映射表。其实，Charlie关心的并不是一个账号的ID，而是ID与公钥的映射关系，那么就可以把公钥（或其密码学哈希值，称为比特币地址）直接作为账号。这样，`From`字段就可以填上Alice（具体叫什么名字已经没有实际意义）的公钥。

紧接着此次交易之后，Bob打算向其他人转账5元钱，并提交一个新交易记录给Charlie。此时，Charlie需要确认上次交易里收款方`To`字段里的Bob和此次交易`From`里付款方公钥的映射关系。显然，这个映射也可以通过将`To`字段填充上收款方的公钥来省略。以公钥为账户就避免了这种额外的映射。这样之前交易记录的内容如下：

```
From: Alice's pub key  
To: Bob's pub key 
Qty: 10
Time: 2018-04-23-17:08
Sig: a signature siged by Alice
```

#### 1.2.2 双重支付与分布式一致性

上述方案中存在两个安全问题：

- 假设Alice账户余额只有10元钱，在其向Bob支付10元钱的同时，也向Dave支付10元钱，这被称为“双重支付”问题。
- 假设负责记账的Charlie作恶，例如故意不记录某些交易，或维护多个不同的账簿，或者账簿被烧毁了，则之前的安全属性无法满足。如果Charlie并不可信，甚至任何个人都不可信，那么我们应该相信谁，或者说谁来记录并维护这个账簿？

下面分别单独考虑这两个问题。

- 为防范Alice对Bob和Dave实施“双重支付”，Bob和Dave只需要确认交易已经被写入Charlie的账簿中，并且该交易之前Alice账户余额充足。因为Alice若实施双重支付，则必须要通过Charlie在账簿中写入两笔交易，而其中较晚的交易由于Alice账户余额不足而无效。可见，只要Charlie是可信的，则“双重支付”问题可以避免。
- 比特币的思想是不相信某个人，而是相信“大多数人是好的”。Bob调整了确认Alice支付交易已经被记入账簿的条件，询问足够多的人（例如超过全体记账人的一半），如果这些人都确认记录了该笔交易，则Bob才认为交易有效。只要大多数人如实地记账，Alice若双重支付，则会被大多数人记录并发现。

比特币系统中有很多人负责记账，这称为“分布式账簿”。进一步的，系统是开放的，记账人并没有事先约定，可以随时加入和退出。这种复杂性带来了两方面安全问题：

- 一致性问题：无法获知系统全局状态，例如有多少记账人。一个交易记录在发送个记账人的过程中可能被阻断、丢失或者延迟，或者攻击者对不同的记账人发送不同的交易记录，导致不同的账簿不一致。
- 女巫(Sybil)攻击：一个攻击者伪装成多个记账人，我们看到的“大多数人”实际上可能只是少数攻击者。

不幸的是，当前理论研究已经证明实现上述问题是无法解决的。

- CAP定理指出，一致性(C，所有复本都一样)、可用性(A，对状态查询做出应答)和分割容忍(P，网络被分割成多个互不连通的部分)三者只能同时满足两点，即当网络分割不可避免时，一致性和可用性不能同时满足。
- FLP不可能性指出，安全性(safety，所有节点输出相同的值)、活性(liveness，非故障节点最终会输出一个值)和容错（fault tolerance，在停机故障或拜占庭故障条件下仍达成前两个目标）不可能在异步(asychronous，消息传递时延无上界)系统中同时满足。

因此，比特币放松了对分布式一致性的要求，而追求一下目标：

- 账簿会暂时不一致，但在概率上最终会收敛，即达成线性一致性。
- 不一致的冲突会以可预测的方式化解。
- 可抵御女巫攻击。

注意，此时的好人不单单是如实记账，还意味着遵守协议并正常运行。

#### 1.2.3 工作量证明(PoW)

先来解决女巫攻击。当根据大多数人的意见来确认一笔交易时，类似于针对该交易的一次全体投票。女巫攻击就是伪造多个身份，从而投出多张选票。防范女巫攻击，需要提高投票成本，但不提高验票的代价。注意，防范女巫攻击不是识别或禁止“坏人的票”，而是防止一人多投。

- 比特币所采用的对策是工作量证明(PoW)，或者说是“一CPU一票”。当记账时，每次记录一个包含多笔交易的区块，同时解决一个计算难题，难题被解决意味着付出了（概率上的）足够的工作量，才能添加区块。

- 难题是寻找（猜测）一个数值Nonce（只出现一次的随机数），使得一个新区块的哈希值小于一个预先指定的数值（哈希值满足开头连续若干位为0）。

```
Nonce: to be determined by guess
Previous block hash
Transacations
```

- 一个节点选择一个新区块的过程：第一个包含了一个计算难题的解的有效区块被认为是正确的。一旦收到它，其它参与者将开始寻找下一区块。如果一个声明的区块包含了无效交易，或者格式错误，那么所有其它参与者将拒绝它，并继续工作直到它们发现一个有效区块的解。

- 难题具有随机性很重要：用非随机的难题（真正的工作量证明），最强大的记账人可能会首先找到每一个区块。通过随机难题，每个记账人找到下一个区块的概率与其竞争算力所占份额成比例。

#### 1.2.4 交易费用、采矿与激励

基于工作量证明的记账需要代价(设备投资、电力和时间)，由此引发两个问题：

- 一个问题是记账人为什么愿意付出算力？
- 攻击者可以产生过多小型交易（称为一分钱泛滥）来过度使用记账服务，从而浪费算力。

针对第一个问题，解决方案是记账人在成功解决难题并记账后会获得一定比特币奖励。最初，每个区块创建50比特币。目前已经减半到25比特币，并且计划约每四年减半，直到约2140年，那时不再创造新比特币。因此，记账活动也称为采矿，记账人也称为矿工。

为了让货币创造能够逐渐关闭，矿工不仅从区块奖励中获利，它们也可以获得区块中包含的交易获得交易费。每笔交易中包含一部分未指定收款方的费用（具体地，交易中还需指定之前交易作为输入，当前交易作为输出，两者之间净值差异为交易费）。

针对第二个问题，矿工会设置一个最小交易费，低于该费用的交易不会被加入到区块中。

#### 1.2.5 P2P网络

分布式账簿需要节点之间有效的发现并通信。任何节点都可以通过连接到一些随机的其他节点来加入网络。 默认情况下，每个节点尝试建立8个外出连接，并准备接收最多125个进入连接。NAT之后的节点（如移动客户端）无法接收进入连接。加入网络的对等体最初需要一个找到其它对等体的方法。像许多其它P2P网络一样，比特币通过使用专用目录服务器或“种子节点”来实现这一目标，其身份被硬编码到参考客户端中; 此后，每个节点维护它所知道的对等地址列表。

对等体还通过其它两种机制传播彼此信息：首先，当一个节点建立一个新的外出连接时，它会触发一系列包含其连接信息的中继消息；其次，在收到进入连接时，节点向其对等方询问一部分已知地址列表。这种机制构建了一个连接良好的随机网络，具有低节点度和低直径，适合通过扩散快速广播信息。

新区块和待处理交易通过洪泛广播到整个网络。无论何时第一次听到它们，节点都会将包含新区块或待处理交易的哈希值的INV消息发送给所有对等节点。如果对等体尚未见过它们，则可以通过请求这些块或交易的全部内容来做出响应（通过GETDATA消息）。默认情况下，节点只会转发一次新数据，以防止无限传播；只传递交易和有效区块；在临时分叉中发现两个区块时只传递第一个听到的区块；不会广播与已发送的待处理交易相冲突（双重支付）的待处理交易。

#### 1.2.6 回到一致性：分布式共识

PoW、激励和P2P网络还不能解决一致性问题，因为还是无法得知参与者的总数和他们的身份：不知道要联系多少人来获得足够多的同意；不知道要联系谁来获得他们的同意，甚至不知道在与谁通话。

一个基本认识是我们联系的人越多，则获得真实信息的可能性也越大；而人头数体现为工作量，所以工作量越大的信息越可信；工作量又体现为账簿上区块的数量。因此，比特币采用了以下共识方案：

- 一条区块链越长。

对于理性的攻击者而言，一个简单的经济学问题：如果收益高于成本，他就会考虑实行攻击。相反，如果可以使攻击成本高于交易的价值，那么应该是安全的。







---
