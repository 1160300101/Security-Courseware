# 沙箱


###哈尔滨工业大学 网络与信息安全 张宇 2016

参考课程: [MIT 6.858 Computer Systems Security](http://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-858-computer-systems-security-fall-2014/index.htm) 

---

本课程首先学习基于能力安全和沙箱的概念；然后学习一种能力+沙箱方案Capsicum。

##基于能力的安全

###糊涂副手问题

[环境权威（ambient authority）](https://en.wikipedia.org/wiki/Ambient_authority)：这是目前操作系统所采用的主要访问控制形式，指权威在一个环境中被隐式行使。

访问请求只需要给出对象的名字和操作，是否允许操作依赖于执行程序的全局属性，如身份或角色。例如，C语言里`open("filename", O_RDONLY, 0)`，其中`filename`本身不具有权威信息，这个操作是否可行依赖于环境权威。

[糊涂副手问题（confused deputy problem）](https://en.wikipedia.org/wiki/Confused_deputy_problem)：在环境权威系统中，一个“糊涂”的特权程序被其他用户/程序“欺骗”来滥用其权利，导致特权扩大。

- 一个计算机安全例子：一个FORTRAN编译服务将用户指定的输入文件编译为指定的输出文件，并在一个账单文件中记录此次服务。一个恶意用户指定账单文件为输出文件来篡改账单，尽管该恶意用户并没有修改账单文件的权限。
- 一个现实安全例子：超市里一个小偷将一个商品的条形码替换成更便宜商品的条形码。“糊涂的收银员“被欺骗直接扫描条码，并按更便宜商品价格收款。小偷的特权被扩大，收银员的特权被滥用。


参考资料：[The Confused Deputy (or why capabilities might have been invented) (1988)](supplyments/The-Confused-Deputy.pdf)

###基于能力的安全

[基于能力（capability）的安全](https://en.wikipedia.org/wiki/Capability-based_security) ：一个能力是一个可交换但不可伪造的权威令牌（token），实现为一个引用(reference)指向一个受保护对象及相关访问权利（right）。

**一个文件访问控制例子：**

- `/etc/passwd` 是一个对象，但未说明权利
- `etc/passwd + O_RDWR ` 是一个带有权利说明的对象，但未说明用户进程是否可以合法访问这些值
- `int fd = open("/etc/passwd", O_RDWR);` 
	- 变量`fd`是在该进程文件描述表中的一个文件描述符索引
	- 文件描述符所在的文件描述表在内核内存中，不能被用户程序直接更改
	- 文件描述符说明该进程确实可合法访问对象，是一个能力

**进程间共享能力：**

- 对于前两个不是能力的例子，若在进程间传递这些信息，会导致糊涂副手问题
- 在基于能力的系统中，能力的传递需要操作系统来保证完整性

**糊涂副手问题的解决方案：**

- 对于糊涂编译器例子：用户向编译服务传递输入/输出文件被打开的文件描述符，而不是文件名。文件描述符可以看做是用户能力的一个凭证。
- 对于超市收款问题，一种解决方案。

注意：Capability-based security不同于[POSIX/Linux capabilities](http://man7.org/linux/man-pages/man7/capabilities.7.html)，后者是对特权的细分。

---

##沙箱

[沙箱（sandbox）](https://en.wikipedia.org/wiki/Sandbox_(computer_security))：一种隔离运行程序的安全机制，常用于执行未测试或不可信程序，避免对操作系统或主机安全造成威胁，可被看做是虚拟化(virtualization)技术的一个特例。

- [jail](https://en.wikipedia.org/wiki/Operating-system-level_virtualization)：一种操作系统级虚拟化，例如限制文件系统访问的chroot，以及[FreeBSD jail](https://en.wikipedia.org/wiki/FreeBSD_jail)（chroot+网络限制），
- 容器：一种操作系统级虚拟化，利用Linux内核的资源分离机制实现独立应用容器，例如[LXC](https://en.wikipedia.org/wiki/LXC)和[Docker](https://en.wikipedia.org/wiki/Docker_(software))
- 基于规则的执行：通过一个明确的规则集来强制限制用户或程序访问（MAC），例如Linux安全模块（Linux Security Module，LSM）框架下的[SELinux](https://en.wikipedia.org/wiki/SELinux)和[Apparmor](https://en.wikipedia.org/wiki/Apparmor)
- [虚拟机](https://en.wikipedia.org/wiki/Virtual_machine)：模拟一个真实操作系统，客户机通过模拟器访问宿主机资源
- [capability](https://en.wikipedia.org/wiki/Capability-based_security)：通过token来表示程序所具备能力
- [seccomp (Secure Computing Mode)](https://en.wikipedia.org/wiki/Seccomp)：Linux内核中一种应用沙箱机制。在该模式下，进程只允许执行`exit()`, `sigreturn()`, 以及对已打开的文件描述符执行`read()` and `write()`, 而禁止其他系统调用
- [JVM（java virtual machines）](https://en.wikipedia.org/wiki/Java_virtual_machine)包括一个沙箱来运行不可信代码，例如Java applet

---

##Capsicum

参考资料：[Capsicum: practical capabilities for UNIX (USENIX Security 2010)](supplyments/Capsicum.pdf)

一种轻量级操作系统能力和沙箱框架（for FreeBSD9）

- 通过增加内核组件和用户空间库来扩展UNIX API
- 可逐渐修改应用程序来采用该框架
- 需要微内核体系和纯消息传递设计

###能力模式
- 通过新的`cap_enter`系统调用设置一个进程凭据标记
- 标记被所有后代进程继承，无法清除
- 能力模式的进程无法访问全局名字空间（例如PID，文件路径，协议地址，IPC，系统时钟等等），例如文件系统和PID名字空间，以及若干系统管理接口（`/dev`, `ioctl`, `reboot`, `kldload`）
- 受限的系统调用（`sysctl`, `shm_open`）只允许创建匿名内存对象；只能操作给定文件描述符下的对象

### 能力
- 通过文件描述符（fd）表示
- fd是不可伪造的授权token, 可被子进程继承或IPC传递
- `cap_new`系统调用在一个存在的fd和一个权力（right）掩码上创建一个能力
- 能力的权力通过内核`fget`检查，该函数负责将fd参数转换为系统调用时内核中引用
- 能力通过fd作为`openat`等系统调用参数来传递，禁止绝对路径，“..”路径，`AT_FDCWD`
- 通过`fexecve`使用setuid和setgid来禁止特权提升

###运行时环境：
- 通过`libcapsicum`库API创建沙箱
- 通过`cap_enter`来切断对全局名字空间的访问
- 关闭未授权的文件描述符
- 通过`fexecve`来清洗地址空间
- 沙箱返回一个UNIX domain套接字用于与主机通信，或获得额外权利

###TCPDUMP例子
- `tcpdump`将一个模式编译为一个BPF过滤器，配置一个BPF设备为输入源，将捕到的包输出为文本
- 沙箱化：先以环境特权获得资源，之后进入能力模式

```c
+       if (cap_enter() < 0)+               error("cap_enter: %s", pcap_strerror(errno));        status = pcap_loop(pd, cnt, callback, pcap_userdata);
```

- 进一步改进，阻止从`stdin`读取，但允许输出


```c
+ + + + + +if (lc_limitfd(STDIN_FILENO, CAP_FSTAT) < 0)        error("lc_limitfd: unable to limit STDIN_FILENO");if (lc_limitfd(STDOUT_FILENO, CAP_FSTAT | CAP_SEEK | CAP_WRITE) < 0)        error("lc_limitfd: unable to limit STDOUT_FILENO");if (lc_limitfd(STDERR_FILENO, CAP_FSTAT | CAP_SEEK | CAP_WRITE) < 0)        error("lc_limitfd: unable to limit STDERR_FILENO");
```

- `procstat -fC`显示进程能力，`stdin`能力只有`fs`(`fstat()`)

```
 PID COMM            FD T     FLAGS CAPABILITIES PRO NAME1268 tcpdump          0 v rw------c           fs -   /dev/pts/01268 tcpdump          1 v -w------c     wr,se,fs -   /dev/null1268 tcpdump          2 v -w------c     wr,se,fs -   /dev/null1268 tcpdump          3 v rw-------            - -   /dev/bpf
```

- `ktrace`显示`tcpdump`使用DNS需要访问文件和网络，而这些在能力模式下已经被禁止，因而出错
	- 这也指出了一个软件设计问题：有些特权是按需的，并不是在程序启动时就需要，因此，沙箱化也需要在软件设计之处就考虑到

```c
  1272 tcpdump CALL  open(0x80092477c,O_RDONLY,<unused>0x1b6)  1272 tcpdump NAMI  "/etc/resolv.conf"  1272 tcpdump RET   connect -1 errno 78 Function not implemented  1272 tcpdump CALL  socket(PF_INET,SOCK_DGRAM,IPPROTO_UDP)  1272 tcpdump RET   socket 4  1272 tcpdump CALL  connect(0x4,0x7fffffffe080,0x10)  1272 tcpdump RET   connect -1 errno 78 Function not implemented
```

###与其他沙箱技术在实现Google Chromium浏览器时的比较

```
OS        Model        Loc       Description
————————————————————————————————————————————————————————————————————————————
Windows   ACL          22,350    Windows ACLs and SIDs
Linux     chroot       605       setuid root helper sandboxes renderer
————————————————————————————————————————————————————————————————————————————
Mac OS X  Seatbelt     560       Path-based MAC sandbox
Linux     SELinux      200       Restricted sandbox type enforement domain
————————————————————————————————————————————————————————————————————————————
Linux     seccomp      11,301    seccomp and userspace syscall wrapper
FreeBSD   Capsicum     100       Capsicum sanboxing using cap_enter

```

---




